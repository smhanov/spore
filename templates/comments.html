{{define "comments"}}
<section class="comment-section">
  {{if .CommentsEnabled}}
  <div class="comment-header">
    <h2>Comments</h2>
  </div>

  <div
    class="comment-panel"
    data-comments
    data-post-slug="{{.Post.Slug}}"
    data-base="{{.RoutePrefix}}"
  >
    <form class="comment-form">
      <div class="comment-inputs-wrapper">
         <input
          class="comment-input-name"
          name="author_name"
          placeholder="Name"
          maxlength="60"
          required
        />
        <textarea
            class="comment-textarea"
            name="content"
            rows="3"
            maxlength="2000"
            placeholder="Write a comment..."
            required
        ></textarea>
      </div>
      
      <div class="comment-toolbar">
         <span class="comment-badge" data-reply-badge hidden></span>
         <div class="comment-actions">
            <button type="button" class="comment-cancel" hidden>Cancel</button>
            <button type="submit" class="comment-submit">Post</button>
         </div>
      </div>
    </form>

    <div class="comment-list" aria-live="polite"></div>
  </div>
  {{else}}
  <div class="comment-disabled">
    <p>Comments are disabled.</p>
  </div>
  {{end}}
</section>

<style>
  /* Comments - Substack style */
  .comment-section {
    max-width: 680px;
    margin: 0 auto;
    padding: 0 20px 64px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  
  .comment-header {
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 24px;
    padding-bottom: 16px;
  }
  .comment-header h2 {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    color: #111827;
  }

  .comment-form {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 32px;
  }

  .comment-inputs-wrapper {
    display: grid;
    gap: 12px;
  }

  .comment-input-name {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .comment-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 15px;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }

  .comment-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  .comment-actions {
    display: flex;
    gap: 12px;
    margin-left: auto;
  }

  .comment-submit {
    background: #111827;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .comment-submit:hover {
    background: #374151;
  }

  .comment-cancel {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    font-size: 14px;
  }
  .comment-cancel:hover {
    color: #374151;
  }
  
  .comment-badge {
    background: #eef2ff;
    color: #4338ca;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
  }

  .comment-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .comment-item {
    border-bottom: 1px solid #f3f4f6;
    padding-bottom: 24px;
  }
  .comment-item:last-child {
    border-bottom: none;
  }

  .comment-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  .comment-author {
    font-weight: 700;
    font-size: 15px;
    color: #111827;
  }
  .comment-time {
    color: #9ca3af;
    font-size: 13px;
  }
  
  .comment-body {
    font-size: 15px;
    line-height: 1.5;
    color: #374151;
    margin-bottom: 8px;
  }

  .comment-actions-row {
     display: flex;
     gap: 16px;
  }
  .comment-link {
    background: none;
    border: none;
    padding: 0;
    color: #6b7280;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
  }
  .comment-link:hover {
    color: #111827;
  }
  .comment-link.danger:hover {
    color: #dc2626;
  }

  .comment-replies {
    margin-top: 24px;
    padding-left: 20px;
    border-left: 2px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .comment-disabled {
    padding: 32px;
    text-align: center;
    color: #6b7280;
    background: #f9fafb;
    border-radius: 8px;
    margin-top: 32px;
  }
  
  .mention {
    color: #2563eb;
    font-weight: 500;
  }
</style>

{{if .CommentsEnabled}}
<script>
  (function () {
    const root = document.querySelector("[data-comments]");
    if (!root) return;

    const postSlug = root.dataset.postSlug;
    const base = root.dataset.base || "";
    const listEl = root.querySelector(".comment-list");
    const form = root.querySelector(".comment-form");
    const nameInput = form.querySelector('input[name="author_name"]');
    const contentInput = form.querySelector('textarea[name="content"]');
    const submitButton = form.querySelector(".comment-submit");
    const cancelButton = form.querySelector(".comment-cancel");
    const replyBadge = form.querySelector("[data-reply-badge]");

    // Store original location of the form
    const formParent = form.parentNode;
    const formNextSibling = form.nextSibling;

    let editingId = null;
    let replyToId = null;
    let replyToName = "";
    let commentIndex = {};

    function escapeHTML(text) {
      return text.replace(/[&<>"']/g, function (ch) {
        switch (ch) {
          case "&":
            return "&amp;";
          case "<":
            return "&lt;";
          case ">":
            return "&gt;";
          case '"':
            return "&quot;";
          case "'":
            return "&#39;";
          default:
            return ch;
        }
      });
    }

    function renderMentions(text) {
      const escaped = escapeHTML(text);
      const withBreaks = escaped.replace(/\n/g, "<br>");
      return withBreaks.replace(
        /(^|\s)@([a-zA-Z0-9_-]{1,30})/g,
        '$1<span class="mention">@$2</span>',
      );
    }

    function formatTime(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });
    }

    function setReplyBadge() {
      if (replyToId && replyToName) {
        replyBadge.textContent = "Replying to " + replyToName;
        replyBadge.hidden = false;
      } else {
        replyBadge.hidden = true;
        replyBadge.textContent = "";
      }
    }

    function moveFormToOriginalLocation() {
      formParent.insertBefore(form, formNextSibling);
    }

    function resetForm() {
      editingId = null;
      replyToId = null;
      replyToName = "";
      contentInput.value = "";
      submitButton.textContent = "Post comment";
      cancelButton.hidden = true;
      setReplyBadge();
      moveFormToOriginalLocation();
    }

    function renderComments(comments) {
      commentIndex = {};
      const html = comments.map(renderComment).join("");
      listEl.innerHTML =
        html ||
        '<div class="comment-item">No comments yet. Be the first to share.</div>';
    }

    function renderComment(comment) {
      commentIndex[comment.id] = comment;
      const status =
        comment.status === "pending"
          ? '<span class="comment-status">Pending review</span>'
          : "";
      const replies =
        comment.replies && comment.replies.length
          ? '<div class="comment-replies">' +
            comment.replies.map(renderReply).join("") +
            "</div>"
          : "";
      const ownedActions = comment.owned
        ? '<button class="comment-link" data-action="edit" data-id="' +
          comment.id +
          '">Edit</button>' +
          '<button class="comment-link danger" data-action="delete" data-id="' +
          comment.id +
          '">Delete</button>'
        : "";
      const replyAction =
        comment.status === "approved"
          ? '<button class="comment-link" data-action="reply" data-id="' +
            comment.id +
            '">Reply</button>'
          : "";
      const itemClass =
        comment.status === "pending" ? "comment-item pending" : "comment-item";

      return (
        '<div class="' +
        itemClass +
        '" data-id="' +
        comment.id +
        '">' +
        '<div class="comment-meta">' +
        '<span class="comment-author">' +
        escapeHTML(comment.author_name) +
        "</span>" +
        '<span class="comment-time">' +
        formatTime(comment.created_at) +
        "</span>" +
        status +
        "</div>" +
        '<div class="comment-body">' +
        renderMentions(comment.content) +
        "</div>" +
        '<div class="comment-actions-row">' +
        replyAction +
        ownedActions +
        "</div>" +
        replies +
        "</div>"
      );
    }

    function renderReply(reply) {
      commentIndex[reply.id] = reply;
      const status =
        reply.status === "pending"
          ? '<span class="comment-status">Pending review</span>'
          : "";
      const ownedActions = reply.owned
        ? '<button class="comment-link" data-action="edit" data-id="' +
          reply.id +
          '">Edit</button>' +
          '<button class="comment-link danger" data-action="delete" data-id="' +
          reply.id +
          '">Delete</button>'
        : "";
      const itemClass =
        reply.status === "pending" ? "comment-item pending" : "comment-item";

      return (
        '<div class="' +
        itemClass +
        '" data-id="' +
        reply.id +
        '">' +
        '<div class="comment-meta">' +
        '<span class="comment-author">' +
        escapeHTML(reply.author_name) +
        "</span>" +
        '<span class="comment-time">' +
        formatTime(reply.created_at) +
        "</span>" +
        status +
        "</div>" +
        '<div class="comment-body">' +
        renderMentions(reply.content) +
        "</div>" +
        '<div class="comment-actions-row">' +
        ownedActions +
        "</div>" +
        "</div>"
      );
    }

    async function loadComments() {
      // Ensure form is safe before we potentially wipe the list
      if (listEl.contains(form)) {
        moveFormToOriginalLocation();
        // Since we moved it, we should probably reset state too to match UI
        resetForm();
      }

      const res = await fetch(base + "/" + postSlug + "/comments");
      if (!res.ok) {
        listEl.innerHTML =
          '<div class="comment-item">Unable to load comments.</div>';
        return;
      }
      const data = await res.json();
      renderComments(data || []);
    }

    async function submitComment() {
      const payload = {
        author_name: nameInput.value.trim(),
        content: contentInput.value.trim(),
      };
      if (replyToId) {
        payload.parent_id = replyToId;
      }

      if (editingId) {
        const res = await fetch(base + "/comments/" + editingId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: payload.content }),
        });
        if (!res.ok) {
          alert("Unable to update comment.");
          return;
        }
        await loadComments();
        resetForm();
        return;
      }

      const res = await fetch(base + "/" + postSlug + "/comments", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const message = await res.text();
        alert(message || "Unable to post comment.");
        return;
      }
      await loadComments();
      resetForm();
    }

    listEl.addEventListener("click", async function (event) {
      const btn = event.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      const comment = commentIndex[id];
      if (!comment) return;

      if (action === "reply") {
        replyToId = comment.id;
        replyToName = comment.author_name;
        setReplyBadge();
        
        // Move form to this comment
        const commentItem = btn.closest('.comment-item');
        // Insert before replies if they exist, or at end
        const repliesDiv = commentItem.querySelector('.comment-replies');
        commentItem.insertBefore(form, repliesDiv);
        
        cancelButton.hidden = false;
        
        contentInput.focus();
        if (!contentInput.value.trim()) {
          contentInput.value = "@" + comment.author_name + " ";
        }
        return;
      }

      if (action === "edit") {
        moveFormToOriginalLocation();
        
        editingId = comment.id;
        nameInput.value = comment.author_name || "";
        contentInput.value = comment.content;
        submitButton.textContent = "Save changes";
        cancelButton.hidden = false;
        contentInput.focus();
        return;
      }

      if (action === "delete") {
        if (!confirm("Delete this comment?")) return;
        const res = await fetch(base + "/comments/" + id, { method: "DELETE" });
        if (!res.ok) {
          alert("Unable to delete comment.");
          return;
        }
        await loadComments();
        return;
      }
    });

    cancelButton.addEventListener("click", function () {
      resetForm();
    });

    form.addEventListener("submit", function (event) {
      event.preventDefault();
      submitComment();
    });

    loadComments();
  })();
</script>
{{end}}
{{end}}
