{{define "content"}}
<div class="article-container">
  <div class="article-header">
    <h1 class="article-title">{{.Post.Title}}</h1>
    {{if .Post.Subtitle}}
    <p class="article-subtitle">{{.Post.Subtitle}}</p>
    {{end}}
    <div class="article-meta">
      {{if .Post.PublishedAt}}
      <span class="meta-item timestamp">
        {{formatPublishedDate .Post.PublishedAt $.DateDisplay}}
      </span>
      {{end}}
      {{/* If you had an author field, it would go here. For now, we assume single author or no author needed */}}
    </div>
  </div>

  <article class="article-content">
    {{safeHTML .Post.ContentHTML}}
  </article>

  {{if .Post.Tags}}
  <div class="article-tags">
    {{range .Post.Tags}}
    <a href="{{$.RoutePrefix}}/tag/{{.Slug}}" class="tag-pill">{{.Name}}</a>
    {{end}}
  </div>
  {{end}}

  <div class="article-divider"></div>

  {{if .RelatedPosts}}
  <section class="related-section">
    <h3 class="section-label">Read Next</h3>
    <div class="related-grid">
      {{range .RelatedPosts}}
      <a href="{{$.RoutePrefix}}/{{.Slug}}" class="related-card">
        {{if .FirstImage}}
        <div
          class="related-image"
          style="background-image: url('{{.FirstImage}}')"
        ></div>
        {{end}}
        <div class="related-body">
          <h4>{{.Title}}</h4>
          {{if .Excerpt}}
          <p>{{.Excerpt}}</p>
          {{end}}
        </div>
      </a>
      {{end}}
    </div>
  </section>
  {{end}}
</div>

<style>
  /* Base Layout */
  body {
    background-color: #ffffff !important;
  }
  .article-container {
    max-width: 680px;
    margin: 0 auto;
    padding: 40px 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #2c3e50;
  }

  /* Typography - Substack/Medium style fonts */
  .article-title {
    font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    font-size: 42px;
    font-weight: 800;
    line-height: 1.1;
    letter-spacing: -0.02em;
    color: #111827;
    margin: 0 0 12px 0;
  }

  .article-subtitle {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    font-size: 22px;
    line-height: 1.4;
    color: #525252;
    margin: 0 0 24px 0;
    font-weight: 400;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 32px;
    font-size: 15px;
    color: #6b7280;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  
  .article-content {
    font-family: "Charter", "Bitstream Charter", "Sitka Text", Cambria, serif;
    font-size: 20px;
    line-height: 1.6;
    color: #292929;
  }
  
  .article-content p {
    margin-bottom: 1.5em;
  }

  .article-content h2 {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 24px;
    font-weight: 700;
    margin: 48px 0 16px;
    color: #111827;
    letter-spacing: -0.01em;
  }

  .article-content h3 {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 20px;
    font-weight: 600;
    margin: 32px 0 12px;
    color: #1f2937;
  }

  .article-content blockquote {
    border-left: 3px solid #111827;
    padding-left: 20px;
    margin: 32px 0;
    font-style: italic;
    color: #4b5563;
  }

  .article-content ul, 
  .article-content ol {
    margin-bottom: 1.5em;
    padding-left: 1.5em;
  }
  
  .article-content li {
    margin-bottom: 0.5em;
  }

  .article-content img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 32px auto;
    display: block;
  }

  .article-content pre,
  .article-content code {
    font-size: 0.7em;
    background: #222;
    color: #ddd;
    padding:0.5em;
    border-radius:10px;
    text-wrap:auto;
  }

  .article-content a {
    color: #2563eb; /* Tailwind blue-600 */
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
  }
  .article-content a:hover {
    color: #1d4ed8;
  }

  /* Tags */
  .article-tags {
    margin-top: 48px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .tag-pill {
    padding: 6px 14px;
    background: #f3f4f6;
    color: #4b5563;
    font-size: 14px;
    border-radius: 999px;
    text-decoration: none;
    transition: all 0.2s ease;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  .tag-pill:hover {
    background: #e5e7eb;
    color: #111827;
  }

  /* Divider */
  .article-divider {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 48px 0;
  }

  /* Related Posts */
  .section-label {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 24px;
    color: #111827;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  .related-grid {
    column-count: 2;
    column-gap: 24px;
    margin-bottom: 64px;
  }

  .related-card {
    display: inline-block;
    vertical-align: top;
    width: 100%;
    break-inside: avoid;
    
    text-decoration: none;
    color: inherit;
    transition: opacity 0.2s;
    
    /* Card styling */
    background-color: #f9fafb;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 24px;
  }
  .related-card:hover {
    opacity: 0.8;
  }

  .related-image {
    width: 100%;
    aspect-ratio: 16/9;
    background-size: cover;
    background-position: center;
    border-radius: 6px;
    margin-bottom: 12px;
    background-color: #f3f4f6;
    border: 1px solid #e5e7eb;
  }
  
  .related-body h4 {
    margin: 0 0 6px;
    font-size: 16px;
    font-weight: 600;
    line-height: 1.4;
    color: #111827;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  
  .related-body p {
    margin: 0;
    font-size: 14px;
    color: #6b7280;
    line-height: 1.5;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Mobile */
  @media (max-width: 640px) {
    .article-title {
      font-size: 32px;
    }
    .article-container {
      padding: 24px 16px;
    }
    .related-grid {
      column-count: 1;
    }
  }
</style>

<section class="comment-section">
  {{if .CommentsEnabled}}
  <div class="comment-header">
    <h2>Comments</h2>
  </div>

  <div
    class="comment-panel"
    data-comments
    data-post-slug="{{.Post.Slug}}"
    data-base="{{.RoutePrefix}}"
  >
    <form class="comment-form">
      <div class="comment-inputs-wrapper">
         <input
          class="comment-input-name"
          name="author_name"
          placeholder="Name"
          maxlength="60"
          required
        />
        <textarea
            class="comment-textarea"
            name="content"
            rows="3"
            maxlength="2000"
            placeholder="Write a comment..."
            required
        ></textarea>
      </div>
      
      <div class="comment-toolbar">
         <span class="comment-badge" data-reply-badge hidden></span>
         <div class="comment-actions">
            <button type="button" class="comment-cancel" hidden>Cancel</button>
            <button type="submit" class="comment-submit">Post</button>
         </div>
      </div>
    </form>

    <div class="comment-list" aria-live="polite"></div>
  </div>
  {{else}}
  <div class="comment-disabled">
    <p>Comments are disabled.</p>
  </div>
  {{end}}
</section>

<style>
  /* Comments - Substack style */
  .comment-section {
    max-width: 680px;
    margin: 0 auto;
    padding: 0 20px 64px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  
  .comment-header {
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 24px;
    padding-bottom: 16px;
  }
  .comment-header h2 {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    color: #111827;
  }

  .comment-form {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 32px;
  }

  .comment-inputs-wrapper {
    display: grid;
    gap: 12px;
  }

  .comment-input-name {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .comment-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 15px;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }

  .comment-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  .comment-actions {
    display: flex;
    gap: 12px;
    margin-left: auto;
  }

  .comment-submit {
    background: #111827;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .comment-submit:hover {
    background: #374151;
  }

  .comment-cancel {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    font-size: 14px;
  }
  .comment-cancel:hover {
    color: #374151;
  }
  
  .comment-badge {
    background: #eef2ff;
    color: #4338ca;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
  }

  .comment-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .comment-item {
    border-bottom: 1px solid #f3f4f6;
    padding-bottom: 24px;
  }
  .comment-item:last-child {
    border-bottom: none;
  }

  .comment-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  .comment-author {
    font-weight: 700;
    font-size: 15px;
    color: #111827;
  }
  .comment-time {
    color: #9ca3af;
    font-size: 13px;
  }
  
  .comment-body {
    font-size: 15px;
    line-height: 1.5;
    color: #374151;
    margin-bottom: 8px;
  }

  .comment-actions-row {
     display: flex;
     gap: 16px;
  }
  .comment-link {
    background: none;
    border: none;
    padding: 0;
    color: #6b7280;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
  }
  .comment-link:hover {
    color: #111827;
  }
  .comment-link.danger:hover {
    color: #dc2626;
  }

  .comment-replies {
    margin-top: 24px;
    padding-left: 20px;
    border-left: 2px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .comment-disabled {
    padding: 32px;
    text-align: center;
    color: #6b7280;
    background: #f9fafb;
    border-radius: 8px;
    margin-top: 32px;
  }
  
  .mention {
    color: #2563eb;
    font-weight: 500;
  }
</style>

{{if .CommentsEnabled}}
<script>
  (function () {
    const root = document.querySelector("[data-comments]");
    if (!root) return;

    const postSlug = root.dataset.postSlug;
    const base = root.dataset.base || "";
    const listEl = root.querySelector(".comment-list");
    const form = root.querySelector(".comment-form");
    const nameInput = form.querySelector('input[name="author_name"]');
    const contentInput = form.querySelector('textarea[name="content"]');
    const submitButton = form.querySelector(".comment-submit");
    const cancelButton = form.querySelector(".comment-cancel");
    const replyBadge = form.querySelector("[data-reply-badge]");

    // Store original location of the form
    const formParent = form.parentNode;
    const formNextSibling = form.nextSibling;

    let editingId = null;
    let replyToId = null;
    let replyToName = "";
    let commentIndex = {};

    function escapeHTML(text) {
      return text.replace(/[&<>"']/g, function (ch) {
        switch (ch) {
          case "&":
            return "&amp;";
          case "<":
            return "&lt;";
          case ">":
            return "&gt;";
          case '"':
            return "&quot;";
          case "'":
            return "&#39;";
          default:
            return ch;
        }
      });
    }

    function renderMentions(text) {
      const escaped = escapeHTML(text);
      const withBreaks = escaped.replace(/\n/g, "<br>");
      return withBreaks.replace(
        /(^|\s)@([a-zA-Z0-9_-]{1,30})/g,
        '$1<span class="mention">@$2</span>',
      );
    }

    function formatTime(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });
    }

    function setReplyBadge() {
      if (replyToId && replyToName) {
        replyBadge.textContent = "Replying to " + replyToName;
        replyBadge.hidden = false;
      } else {
        replyBadge.hidden = true;
        replyBadge.textContent = "";
      }
    }

    function moveFormToOriginalLocation() {
      formParent.insertBefore(form, formNextSibling);
    }

    function resetForm() {
      editingId = null;
      replyToId = null;
      replyToName = "";
      contentInput.value = "";
      submitButton.textContent = "Post comment";
      cancelButton.hidden = true;
      setReplyBadge();
      moveFormToOriginalLocation();
    }

    function renderComments(comments) {
      commentIndex = {};
      const html = comments.map(renderComment).join("");
      listEl.innerHTML =
        html ||
        '<div class="comment-item">No comments yet. Be the first to share.</div>';
    }

    function renderComment(comment) {
      commentIndex[comment.id] = comment;
      const status =
        comment.status === "pending"
          ? '<span class="comment-status">Pending review</span>'
          : "";
      const replies =
        comment.replies && comment.replies.length
          ? '<div class="comment-replies">' +
            comment.replies.map(renderReply).join("") +
            "</div>"
          : "";
      const ownedActions = comment.owned
        ? '<button class="comment-link" data-action="edit" data-id="' +
          comment.id +
          '">Edit</button>' +
          '<button class="comment-link danger" data-action="delete" data-id="' +
          comment.id +
          '">Delete</button>'
        : "";
      const replyAction =
        comment.status === "approved"
          ? '<button class="comment-link" data-action="reply" data-id="' +
            comment.id +
            '">Reply</button>'
          : "";
      const itemClass =
        comment.status === "pending" ? "comment-item pending" : "comment-item";

      return (
        '<div class="' +
        itemClass +
        '" data-id="' +
        comment.id +
        '">' +
        '<div class="comment-meta">' +
        '<span class="comment-author">' +
        escapeHTML(comment.author_name) +
        "</span>" +
        '<span class="comment-time">' +
        formatTime(comment.created_at) +
        "</span>" +
        status +
        "</div>" +
        '<div class="comment-body">' +
        renderMentions(comment.content) +
        "</div>" +
        '<div class="comment-actions-row">' +
        replyAction +
        ownedActions +
        "</div>" +
        replies +
        "</div>"
      );
    }

    function renderReply(reply) {
      commentIndex[reply.id] = reply;
      const status =
        reply.status === "pending"
          ? '<span class="comment-status">Pending review</span>'
          : "";
      const ownedActions = reply.owned
        ? '<button class="comment-link" data-action="edit" data-id="' +
          reply.id +
          '">Edit</button>' +
          '<button class="comment-link danger" data-action="delete" data-id="' +
          reply.id +
          '">Delete</button>'
        : "";
      const itemClass =
        reply.status === "pending" ? "comment-item pending" : "comment-item";

      return (
        '<div class="' +
        itemClass +
        '" data-id="' +
        reply.id +
        '">' +
        '<div class="comment-meta">' +
        '<span class="comment-author">' +
        escapeHTML(reply.author_name) +
        "</span>" +
        '<span class="comment-time">' +
        formatTime(reply.created_at) +
        "</span>" +
        status +
        "</div>" +
        '<div class="comment-body">' +
        renderMentions(reply.content) +
        "</div>" +
        '<div class="comment-actions-row">' +
        ownedActions +
        "</div>" +
        "</div>"
      );
    }

    async function loadComments() {
      // Ensure form is safe before we potentially wipe the list
      if (listEl.contains(form)) {
        moveFormToOriginalLocation();
        // Since we moved it, we should probably reset state too to match UI
        resetForm();
      }

      const res = await fetch(base + "/" + postSlug + "/comments");
      if (!res.ok) {
        listEl.innerHTML =
          '<div class="comment-item">Unable to load comments.</div>';
        return;
      }
      const data = await res.json();
      renderComments(data || []);
    }

    async function submitComment() {
      const payload = {
        author_name: nameInput.value.trim(),
        content: contentInput.value.trim(),
      };
      if (replyToId) {
        payload.parent_id = replyToId;
      }

      if (editingId) {
        const res = await fetch(base + "/comments/" + editingId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: payload.content }),
        });
        if (!res.ok) {
          alert("Unable to update comment.");
          return;
        }
        await loadComments();
        resetForm();
        return;
      }

      const res = await fetch(base + "/" + postSlug + "/comments", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const message = await res.text();
        alert(message || "Unable to post comment.");
        return;
      }
      await loadComments();
      resetForm();
    }

    listEl.addEventListener("click", async function (event) {
      const btn = event.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      const comment = commentIndex[id];
      if (!comment) return;

      if (action === "reply") {
        replyToId = comment.id;
        replyToName = comment.author_name;
        setReplyBadge();
        
        // Move form to this comment
        const commentItem = btn.closest('.comment-item');
        // Insert before replies if they exist, or at end
        const repliesDiv = commentItem.querySelector('.comment-replies');
        commentItem.insertBefore(form, repliesDiv);
        
        cancelButton.hidden = false;
        
        contentInput.focus();
        if (!contentInput.value.trim()) {
          contentInput.value = "@" + comment.author_name + " ";
        }
        return;
      }

      if (action === "edit") {
        moveFormToOriginalLocation(); // Ensure form is at top for edit (simplest for now)
        // Or move to comment? Let's keep it simple as planned: reply moves, edit resets to top.
        // Actually, if we are editing, standard behavior is usually inline edit.
        // But implementing inline edit properly requires swapping BODY with FORM.
        // Repurposing "Move form under comment" for edit is slightly weird (you see original text + form).
        // So I will stick to "Edit moves form to top" (default) to avoid confusion.
        
        editingId = comment.id;
        nameInput.value = comment.author_name || "";
        contentInput.value = comment.content;
        submitButton.textContent = "Save changes";
        cancelButton.hidden = false;
        contentInput.focus();
        return;
      }

      if (action === "delete") {
        if (!confirm("Delete this comment?")) return;
        const res = await fetch(base + "/comments/" + id, { method: "DELETE" });
        if (!res.ok) {
          alert("Unable to delete comment.");
          return;
        }
        await loadComments();
        return;
      }
    });

    cancelButton.addEventListener("click", function () {
      resetForm();
    });

    form.addEventListener("submit", function (event) {
      event.preventDefault();
      submitComment();
    });

    loadComments();
  })();
</script>
{{end}} {{end}} {{define "post.html"}} {{template "base.html" .}} {{end}}
